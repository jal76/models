#define TAK

piece	base, track, link1, link2, train, spawner;
static-var	trainId, link1Id, link2Id, otherLink1, otherLink2;
static-var	isBlocked;

#define SIG_DEATH		1
#define SIG_STOP		2
#define SIG_TRAINENTER	4

#define LINK1_Z			[-5]
#define LINK2_Z			[5]
#define TRAIN_SPEED		[5]

#include "railroad.h"

Create()
{
	isBlocked = FALSE;
	trainId = -1;
	link1Id = -1;
	link2Id = -1;
}

Expand()
{
	var xz, x, y, z, dir, teamID;
	// create 2 more pieces - one at each free end. Auto-link to them.
	if(link1Id == -1)
	{
		// create piece at link1
		move spawner to z-axis 2*LINK1_Z now;
		xz=get PIECE_XZ(spawner);
		x=xz/65536;
		z=xz MOD 65536;
		y=get PIECE_Y(spawner);
		dir=get HEADING;
		teamID = get UNIT_TEAM(get MY_ID);
		call-script lua_CreateRailTrack(RAILTRACK_SMALL, teamID, x, y, z, dir, 1);
		move spawner to z-axis 0 now;
		// unit we just made will be auto-linked back to this piece by lua
	}
	if(link2Id == -1)
	{
		// create piece at link1
		move spawner to z-axis 2*LINK2_Z now;
		xz=get PIECE_XZ(spawner);
		x=xz/65536;
		z=xz MOD 65536;
		y=get PIECE_Y(spawner);
		dir=get HEADING;
		teamID = get UNIT_TEAM(get MY_ID);
		call-script lua_CreateRailTrack(RAILTRACK_SMALL, teamID, x, y, z, dir, 2);
		move spawner to z-axis 0 now;
	}
}

Killed()
{
	signal SIG_DEATH;
	// notify linked pieces this one is out
	/* lua should do that
	if (link1Id > 0)
	{
		call-script lua_SetLink(link1Id, -1, otherLink1, 0);
	}
	if (link2Id > 0)
	{
		call-script lua_SetLink(link2Id, -1, otherLink2, 0);
	}
	*/
}